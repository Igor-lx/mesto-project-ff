(()=>{"use strict";function e(e){e.remove()}function t(e){e.classList.toggle("card__like-button_is-active")}function n(e,t){e.classList.toggle("my_like_is-active"),e.textContent=t.likes.length}function o(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",c),e.addEventListener("mousedown",a)}function r(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",c),e.removeEventListener("mousedown",a)}function a(e){(e.target.classList.contains("popup_is-opened")||e.target.classList.contains("popup__close"))&&r(e.currentTarget)}function c(e){"Escape"===e.key&&r(document.querySelector(".popup_is-opened"))}var i={modalWindow:document.querySelector(".popup_type_likes"),imgName:document.querySelector(".popup_likes_image_name"),imgAutor:document.querySelector(".popup_likes_image_autor"),text:document.querySelector(".popup__title_likes"),likersNames:document.querySelector(".likers-names")};function l(e,t,n,o){return n(o).then((function(n){var o=n.find((function(t){return t._id===e}));if(o)if(i.imgName.textContent="".concat(o.name),i.imgAutor.textContent="Автор: ".concat(o.owner.name),i.imgName.classList.remove("popup__content_no_likes"),o.likes.length>0){t.textContent=o.likes.length;var r=o.likes.map((function(e){return e.name})).join(", ");i.text.textContent="Это фото понравилось:",i.likersNames.textContent=r}else i.imgName.textContent="У этой карточки нет лайков",i.imgName.classList.add("popup__content_no_likes"),i.imgAutor.textContent="";else i.imgName.textContent="Карточка не найдена"})).catch((function(e){return console.log("Ошибка: ".concat(e))}))}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}var d={loadingText:"Сохранение...",completedText:"Сохранено"},s={loadingText:"Удаление...",completedText:"Удалено"},m={loadingText:"Обновление...",completedText:"Обновлено"},f={completedText:"Ошибка"};function p(e,t,n,o,r){var a=o.querySelector(".popup__button");a.dataset.originalText||(a.dataset.originalText=a.textContent),e?a.textContent=a.dataset.originalText:t?a.textContent=r.loadingText:n&&(a.textContent=r.completedText)}function _(e,t,n,o){o(e),n(t)}function y(e,t,n,o){return e(t).then((function(e){if(!e.ok)throw new Error("Ошибка: ".concat(e.status));var r=e.headers.get(n);if(!r)throw new Error('Заголовок "'.concat(n,'" отсутствует в ответе.'));if(!r.startsWith(o))throw new Error('Недопустимое значение заголовка "'.concat(n,'": ').concat(r));return t}))}function v(e,t,n,o){var r=e.querySelector("#".concat(t.id).concat(o.errorClassPostfix));t.classList.add(o.inputfieldErrorStyleClass),r.classList.add(o.textmessageErrorStyleClass),r.textContent=n}function h(e,t,n){var o=e.querySelector("#".concat(t.id).concat(n.errorClassPostfix));t.classList.remove(n.inputfieldErrorStyleClass),o.classList.remove(n.textmessageErrorStyleClass),o.textContent=""}function S(e,t,n){e.some((function(e){return!e.validity.valid}))?(t.classList.add(n.inactiveButtonClass),t.disabled=!0):(t.classList.remove(n.inactiveButtonClass),t.disabled=!1)}function g(e,t){var n=Array.from(e.querySelectorAll(t.inputfieldSelector)),o=e.querySelector(t.submitButtonSelector);n.forEach((function(n){return h(e,n,t)})),S(n,o,t)}function k(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}function E(e){return fetch("".concat(e.baseUrl).concat(e.userDataEndpoint),{headers:e.headers}).then(k)}function b(e){return fetch("".concat(e.baseUrl).concat(e.cardsEndpoint),{headers:e.headers}).then(k)}function C(e,t){return fetch("".concat(t.baseUrl).concat(t.cardsEndpoint),{method:"POST",headers:t.headers,body:JSON.stringify(e)}).then(k)}function q(e,t){return fetch("".concat(t.baseUrl).concat(t.cardsEndpoint,"/").concat(e),{method:"DELETE",headers:t.headers}).then(k)}function L(e){return fetch(e,{method:"HEAD"})}function x(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,a,c,i=[],l=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=a.call(n)).done)&&(i.push(o.value),i.length!==t);l=!0);}catch(e){u=!0,r=e}finally{try{if(!l&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(u)throw r}}return i}}(e,t)||function(e,t){if(e){if("string"==typeof e)return w(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?w(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}var A={formSelector:".popup__form",inputfieldSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputfieldErrorStyleClass:"popup__input_error",textmessageErrorStyleClass:"popup__error-message_visible",errorClassPostfix:"-error"},N={baseUrl:"https://nomoreparties.co/v1/wff-cohort-28",userDataEndpoint:"/users/me",userAvatarEndpoint:"/users/me/avatar",cardsEndpoint:"/cards",likesEndpoint:"/cards/likes/",headers:{authorization:"4539d8f5-d367-42ca-b41c-d2390bc8734d","Content-Type":"application/json"}},T={editButton:document.querySelector(".profile__edit-button"),modalWindow:document.querySelector(".popup_type_edit"),formElement:document.querySelector('[name="edit-profile"]'),inputfieldName:document.querySelector('[name="person_name"]'),inputfieldJob:document.querySelector('[name="person_description"]'),name:document.querySelector(".profile__title"),job:document.querySelector(".profile__description"),avatar:document.querySelector(".profile__image")},I=document.querySelector('[name="new-place"]'),j=document.querySelector(".profile__add-button"),D=document.querySelector(".popup_type_new-card"),O=document.querySelector('[name="newplace_name"]'),P=document.querySelector('[name="newplace_url"]'),B=document.querySelector(".popup__image"),U=document.querySelector(".popup__caption"),M=document.querySelector(".popup__autor"),J=document.querySelector(".popup_type_image"),W=document.querySelector('[name="edit_avatar"]'),H=document.querySelector(".edit_avatar"),F=document.querySelector(".popup_type_avatar"),$=document.querySelector('[name="avatar_url"]'),z=document.querySelector(".popup_type_delete-confirm"),G=z.querySelector(".popup__button"),K=document.querySelector(".popup_type_card_name_change"),Q=document.querySelector('[name="edit_cardname"]'),R=document.querySelector('[name="edit_cardname_input"]'),V=K.querySelector(".popup__button"),X=document.querySelector(".popup_type_update-confirm"),Y=X.querySelector(".popup__button"),Z=document.querySelector(".refresh-card_button"),ee=document.querySelector(".card__like-button_fullscreen"),te=document.querySelector(".likes_counter_fullscreen"),ne=document.querySelector(".popup_type_error"),oe=null,re={name:null,cardId:null,cardElement:null,link:null,userId:null,likes:null,likeButtonNode:null,likeCounterNode:null},ae={name:null,link:null},ce={name:null,about:null};function ie(e){Object.keys(e).forEach((function(t){e[t]=null}))}var le=document.querySelector(".places__list");function ue(e){le.prepend(function(e,t,n){var o=document.querySelector("#card-template").content.querySelector(".card").cloneNode(!0),r=o.querySelector(".card__title"),a=o.querySelector(".card__image");r.textContent=e.name;var c=o.querySelector(".card__description"),i=o.querySelector(".likes_section"),l=o.querySelector(".image__editname-button");a.src=e.link,a.alt='фотография: "'+e.name+'"';var u=o.querySelector(".card__delete-button"),d=o.querySelector(".image__editname-button"),s=o.querySelector(".card__like-button"),m=o.querySelector(".likes_counter");return m.textContent=e.likes.length,n.showButtonsOnCard(e,t,u,d),n.IfAlreadyLiked(e.likes,t,s,m,o),u&&u.addEventListener("click",(function(){n.openConfirmDeleteModal(e,o)})),d&&d.addEventListener("click",(function(){n.openChangeCardNameModal(e,o)})),s&&s.addEventListener("click",(function(){n.handleLikeCard(e._id,s,m,o)})),m&&m.addEventListener("click",(function(){n.openLikersModal(e._id,m)})),a.addEventListener("click",(function(){a.classList.contains("card__image__load_failure")||n.openFullscreenImage(e,s,m,o)})),a.addEventListener("error",(function(){n.processImgDownldError(a,r,c,i,l)}),{once:!0}),o}(e,oe,me))}function de(e){e.closest(".popup__content").querySelector(".clear_form").addEventListener("click",(function(){e.reset(),g(e,A)}))}Promise.all([E(N),b(N)]).then((function(e){var t=x(e,2),n=t[0],o=t[1];oe=n._id,T.name.textContent=n.name,T.job.textContent=n.about,T.avatar.style.backgroundImage="url(".concat(n.avatar,")"),o.reverse().forEach((function(e){ue(e)}))})).catch((function(e){return console.log("Ошибка: ".concat(e))})),Z.addEventListener("click",(function(){return function(e,t,n,o,r,a){var c=document.querySelectorAll(".places__item");Promise.all([e(n),t(n)]).then((function(e){var t,n,o=(n=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,a,c,i=[],l=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=a.call(n)).done)&&(i.push(o.value),i.length!==t);l=!0);}catch(e){u=!0,r=e}finally{try{if(!l&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(u)throw r}}return i}}(t,n)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=o[0],l=o[1];c.forEach((function(e){r(e)})),i._id,l.reverse().forEach((function(e){a(e)}))})).catch((function(e){return console.log("Ошибка: ".concat(e))}))}(E,b,N,0,e,ue)})),T.editButton.addEventListener("click",(function(){var e;p(!0,!1,!1,T.formElement,d),T.inputfieldName.value=T.name.textContent,T.inputfieldJob.value=T.job.textContent,o(T.modalWindow),g(T.formElement,A),(e=T.formElement).closest(".popup__content").querySelector(".clear_form").addEventListener("click",(function(){g(e,A),T.inputfieldName.value=T.name.textContent,T.inputfieldJob.value=T.job.textContent}))})),j.addEventListener("click",(function(){p(!0,!1,!1,I,d),I.reset(),o(D),g(I,A),de(I)})),H.addEventListener("click",(function(){p(!0,!1,!1,W,d),W.reset(),o(F),g(W,A),de(W)})),T.formElement.addEventListener("submit",(function(e){e.preventDefault(),ce.name=T.inputfieldName.value,ce.about=T.inputfieldJob.value;var t,n,o=ce.name!==T.name.textContent,a=ce.about!==T.job.textContent;if(!o&&!a)return console.log("Данные не изменились, запрос на сервер не был отправлен за ненадобностью."),r(T.modalWindow),void ie(ce);p(!1,!0,!1,T.formElement,d),(t=ce,n=N,fetch("".concat(n.baseUrl).concat(n.userDataEndpoint),{method:"PATCH",headers:n.headers,body:JSON.stringify(t)}).then(k)).then((function(e){T.name.textContent=e.name,T.job.textContent=e.about,r(T.modalWindow),ie(e),p(!1,!1,!0,T.formElement,d)})).catch((function(e){console.log("Ошибка: ".concat(e)),p(!1,!1,!0,T.formElement,f)}))})),I.addEventListener("submit",(function(e){e.preventDefault(),ae.name=O.value,ae.link=P.value,p(!1,!0,!1,I,d),y(L,ae.link,"Content-Type","image/").catch((function(e){return p(!1,!1,!0,I,f),_(D,ne,o,r),Promise.reject(e)})).then((function(){return C(ae,N)})).then((function(e){ue(e),p(!1,!1,!0,I,d),ie(ae),r(D)})).catch((function(e){console.error("Ошибка: ".concat(e)),p(!1,!1,!0,I,f)}))})),W.addEventListener("submit",(function(e){e.preventDefault();var t=$.value;p(!1,!0,!1,W,d),y(L,t,"Content-Type","image/").catch((function(e){return p(!1,!1,!0,W,f),_(F,ne,o,r),Promise.reject(e)})).then((function(e){return t=e,n=N,fetch("".concat(n.baseUrl).concat(n.userAvatarEndpoint),{method:"PATCH",headers:n.headers,body:JSON.stringify({avatar:t})}).then(k);var t,n})).then((function(e){T.avatar.style.backgroundImage="url(".concat(e.avatar,")"),p(!1,!1,!0,W,d),r(F)})).catch((function(e){console.error("Ошибка: ".concat(e)),p(!1,!1,!0,W,f)}))}));var se,me={showButtonsOnCard:function(e,t,n,o){e.owner._id!==t&&(n.remove(),o.remove())},openConfirmDeleteModal:function(e,t){p(!0,!1,!1,z,s),re.cardId=e._id,re.cardElement=t,o(z)},openChangeCardNameModal:function(e,t){var n,r;re.cardId=e._id,re.cardElement=t,re.link=e.link,re.name=e.name,R.value=e.name,o(K),g(Q,A),n=Q,r=e.name,n.closest(".popup__content").querySelector(".clear_form").addEventListener("click",(function(){g(n,A),R.value=r}))},IfAlreadyLiked:fe,handleLikeCard:pe,openFullscreenImage:function(e,t,n,r){re.cardId=e._id,re.likeButtonNode=t,re.likeCounterNode=n,re.cardElement=r,B.src=e.link,B.alt='фотография: "'+e.name+'"',U.textContent=e.name,M.textContent="Автор: "+e.owner.name,Promise.all([E(N),b(N)]).then((function(e){var t=x(e,2),r=t[0],a=t[1].find((function(e){return e._id===re.cardId})),c=a?a.likes:[];fe(c,r._id,ee,te,re.cardElement),te.textContent=c.length,o(J),n.textContent=c.length})).catch((function(e){return console.log("Ошибка: ".concat(e))}))},processImgDownldError:function(e,t,n,o,r){e.classList.add("card__image__load_failure__textstile","card__image__load_failure"),t.classList.add("card__image__load_failure__textstile"),t.textContent="Упс! Изображение не найдено, но мы уже отправили за ним поисковую команду.",n.classList.add("card__image__load_failure__description"),o.style.display="none",r&&(r.style.display="none"),e.style.cursor="not-allowed"},openLikersModal:function(e,t){var n;n=i,Object.keys(n).slice(1).forEach((function(e){n[e].textContent=""})),o(i.modalWindow),l(e,t,b,N)},showLikedUsers:l};function fe(e,t,n,o,r){e.some((function(e){return e._id===t}))?(n.classList.add("card__like-button_is-active"),o.classList.add("my_like_is-active"),r.classList.add("liked_shadow")):(n.classList.remove("card__like-button_is-active"),o.classList.remove("my_like_is-active"),r.classList.remove("liked_shadow"))}function pe(e,o,r,a){(function(e,t,n){var o=t?"DELETE":"PUT";return fetch("".concat(n.baseUrl).concat(n.likesEndpoint).concat(e),{method:o,headers:n.headers}).then(k)})(e,o.classList.contains("card__like-button_is-active"),N).then((function(e){t(o),t(ee),n(r,e),n(te,e),a.classList.toggle("liked_shadow")})).catch((function(e){return console.log("Ошибка: ".concat(e))}))}V.addEventListener("click",(function(){_(K,X,o,r),p(!0,!1,!1,X,m)})),Y.addEventListener("click",(function(){ae.name=R.value,ae.link=re.link,p(!1,!0,!1,X,m),Promise.all([q(re.cardId,N),C(ae,N)]).then((function(t){var n=x(t,2),o=(n[0],n[1]);e(re.cardElement),ue(o),r(X),ie(re),p(!1,!1,!0,X,m)})).catch((function(e){p(!1,!1,!0,X,f),console.log("Ошибка: ".concat(e))}))})),G.addEventListener("click",(function(){p(!1,!0,!1,z,s),q(re.cardId,N).then((function(){e(re.cardElement),r(z),ie(re),p(!1,!1,!0,z,s)})).catch((function(e){p(!1,!1,!0,z,f),console.log("Ошибка: ".concat(e))}))})),ee.addEventListener("click",(function(){pe(re.cardId,re.likeButtonNode,re.likeCounterNode,re.cardElement)})),se=A,Array.from(document.querySelectorAll(se.formSelector)).forEach((function(e){e.addEventListener("submit",(function(e){return e.preventDefault()}));var t=Array.from(e.querySelectorAll(se.inputfieldSelector)),n=e.querySelector(se.submitButtonSelector);S(t,n,se),t.forEach((function(o){o.addEventListener("input",(function(){!function(e,t,n){t.validity.patternMismatch?v(e,t,t.dataset.errorMessage,n):t.validity.valid?h(e,t,n):v(e,t,t.validationMessage,n)}(e,o,se),S(t,n,se)}))}))}))})();